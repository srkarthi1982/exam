---
import { AvBreadcrumb, AvButton, AvCard, AvContainer, AvEmptyState } from "@ansiversa/components";
import AppShell from "../layouts/AppShell.astro";

const title = "Exam Simulator – Ansiversa";
const description = "Timed mock exams with instant scoring.";
const isPaid = Boolean(Astro.locals.user?.isPaid);
---

<AppShell title={title} description={description}>
  <section class="av-faq-public__crumb">
    <AvContainer>
      <AvBreadcrumb items={[{ label: "Exams" }]} />
    </AvContainer>
  </section>

  <section
    class="av-section"
    x-data
    x-init={`$store.exam.setBillingStatus(${isPaid}); $store.exam.loadPapers(); $store.exam.loadAttempts();`}
  >
    <AvContainer>
      <div class="av-auth-stack-lg">
        <AvCard className="av-auth-stack-md">
          <div class="av-auth-stack-sm">
            <div>
              <p class="av-kicker">Exam Simulator</p>
              <h1 class="av-section-title">Your exams</h1>
              <p class="av-text-soft">Create a mock exam and test yourself under time pressure.</p>
            </div>
            <div class="av-row-wrap">
              <AvButton href="/papers/new">Create exam paper</AvButton>
              <AvButton href="/history" variant="ghost">View history</AvButton>
            </div>
          </div>
        </AvCard>

        <AvCard variant="soft" className="av-auth-stack-md">
          <div class="av-row-between">
            <h2 class="av-card-heading">Exam papers</h2>
            <AvButton href="/papers" variant="ghost">All papers</AvButton>
          </div>

          <template x-if="$store.exam.papers.length === 0 && !$store.exam.loading">
            <AvEmptyState title="No exam papers yet" description="Create your first exam paper." />
          </template>

          <div class="av-auth-stack-sm" x-show="$store.exam.papers.length > 0">
            <template x-for="paper in $store.exam.papers" :key="paper.id">
              <div class="av-card av-card-soft av-auth-stack-xs">
                <div class="av-row-between">
                  <div>
                    <h3 class="av-card-heading" x-text="paper.title"></h3>
                    <p class="av-text-soft" x-text="`${paper.questionCount} questions · ${paper.timeLimitMinutes} min`"></p>
                  </div>
                  <div class="av-row-wrap">
                    <a class="av-btn-primary av-btn-sm" x-bind:href="`/papers/${paper.id}`">Open</a>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </AvCard>

        <AvCard variant="soft" className="av-auth-stack-md">
          <div class="av-row-between">
            <h2 class="av-card-heading">Recent attempts</h2>
            <AvButton href="/history" variant="ghost">Full history</AvButton>
          </div>

          <template x-if="$store.exam.attempts.length === 0 && !$store.exam.loading">
            <AvEmptyState title="No attempts yet" description="Start an exam to see results." />
          </template>

          <div class="av-auth-stack-sm" x-show="$store.exam.attempts.length > 0">
            <template x-for="attempt in $store.exam.attempts.slice(0, 5)" :key="attempt.id">
              <div class="av-card av-card-soft av-auth-stack-xs">
                <div class="av-row-between">
                  <div>
                    <h3 class="av-card-heading" x-text="`Attempt #${attempt.id}`"></h3>
                    <p class="av-text-soft" x-text="attempt.status"></p>
                  </div>
                  <div class="av-row-wrap">
                    <a class="av-btn-ghost av-btn-sm" x-bind:href="`/results/${attempt.id}`">Results</a>
                  </div>
                </div>
                <p class="av-text-soft" x-text="new Date(attempt.startedAt).toLocaleString()"></p>
              </div>
            </template>
          </div>
        </AvCard>
      </div>
    </AvContainer>
  </section>
</AppShell>
